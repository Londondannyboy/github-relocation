---
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from '../../lib/sanity';
import { getBodyImageUrl, getFeaturedImageUrl } from '../../lib/imageUtils.js';

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(
    `*[_type == "post"] { slug }`
  );
  return posts.map(post => ({
    params: { slug: post.slug.current }
  }));
}

const { slug } = Astro.params;

// Fetch complete post data
const post = await sanityClient.fetch(
  `*[_type == "post" && slug.current == $slug][0] {
    _id,
    title,
    slug,
    excerpt,
    body,
    publishedAt,
    featuredImage {
      asset-> { url },
      alt,
      credit
    },
    videoUrl,
    category-> {
      title,
      slug
    },
    tags[]-> {
      title,
      slug
    },
    metaTitle,
    metaDescription,
    focusKeyword,
    searchVolume,
    cpc,
    contentTier,
    generationCost
  }`,
  { slug }
);

if (!post) {
  return Astro.redirect('/404');
}

const pageTitle = post.metaTitle || post.title;
const pageDescription = post.metaDescription || post.excerpt;

// Extract MUX video ID if present
function getMuxId(url) {
  if (!url) return null;
  const match = url.match(/([a-zA-Z0-9]{20,})/);
  return match ? match[1] : null;
}

// Render portable text content
function renderContent(blocks) {
  if (!blocks) return '';
  
  return blocks.map(block => {
    if (block._type === 'block') {
      const style = block.style || 'normal';
      const children = block.children?.map(child => {
        if (child._type === 'span') {
          let text = child.text || '';
          
          // Apply marks
          if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
          if (child.marks?.includes('em')) text = `<em>${text}</em>`;
          if (child.marks?.includes('code')) text = `<code class="bg-gray-100 px-1 rounded">${text}</code>`;
          
          // Handle links
          child.marks?.forEach(mark => {
            const markDef = block.markDefs?.find(def => def._key === mark);
            if (markDef?._type === 'link') {
              const external = markDef.href?.startsWith('http');
              text = `<a href="${markDef.href}" class="text-blue-600 hover:text-blue-800 underline"${external ? ' target="_blank"' : ''}>${text}</a>`;
            }
          });
          
          return text;
        }
        return '';
      }).join('');
      
      // Apply styles
      if (style === 'h2') return `<h2 class="text-3xl font-bold mt-8 mb-4">${children}</h2>`;
      if (style === 'h3') return `<h3 class="text-2xl font-bold mt-6 mb-3">${children}</h3>`;
      if (style === 'h4') return `<h4 class="text-xl font-bold mt-4 mb-2">${children}</h4>`;
      if (style === 'blockquote') return `<blockquote class="border-l-4 border-blue-500 pl-4 my-4 italic">${children}</blockquote>`;
      return `<p class="mb-4 leading-relaxed">${children}</p>`;
    }
    
    // Handle images
    if (block._type === 'image') {
      const url = block.asset?.url || '';
      const alt = block.alt || '';
      // Use JPEG format for body images for better compatibility
      const optimizedUrl = getBodyImageUrl(url);
      return `<figure class="my-8"><img src="${optimizedUrl}" alt="${alt}" class="w-full rounded-lg shadow-lg" loading="lazy" /></figure>`;
    }
    
    return '';
  }).join('');
}

const muxId = getMuxId(post.videoUrl);
const content = renderContent(post.body);
---

<Layout title={pageTitle} description={pageDescription}>
  <article class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Breadcrumbs -->
    <nav class="text-sm mb-6">
      <a href="/" class="text-blue-600 hover:underline">Home</a>
      <span class="mx-2">/</span>
      <a href="/posts" class="text-blue-600 hover:underline">Posts</a>
      <span class="mx-2">/</span>
      <span class="text-gray-600">{post.title}</span>
    </nav>

    <!-- Header -->
    <header class="mb-8">
      {post.category && (
        <span class="text-blue-600 font-semibold uppercase text-sm">
          {post.category.title}
        </span>
      )}
      <h1 class="text-4xl md:text-5xl font-bold mt-2 mb-4">{post.title}</h1>
      
      <div class="flex items-center gap-4 text-gray-600">
        <time datetime={post.publishedAt}>
          {post.publishedAt && new Date(post.publishedAt).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}
        </time>
        {post.searchVolume && (
          <>
            <span>•</span>
            <span>{post.searchVolume} searches/month</span>
          </>
        )}
        {post.cpc && (
          <>
            <span>•</span>
            <span>${post.cpc} CPC</span>
          </>
        )}
      </div>
    </header>

    <!-- Featured Media -->
    {muxId ? (
      <div class="mb-8">
        <mux-player
          playback-id={muxId}
          metadata-video-title={post.title}
          accent-color="#10b981"
          autoplay
          muted
          loop
          class="w-full rounded-lg shadow-lg"
        ></mux-player>
        <script src="https://cdn.jsdelivr.net/npm/@mux/mux-player"></script>
      </div>
    ) : post.featuredImage?.asset?.url && (
      <figure class="mb-8">
        <img 
          src={getFeaturedImageUrl(post.featuredImage.asset.url)} 
          alt={post.featuredImage.alt || post.title}
          class="w-full rounded-lg shadow-lg"
          loading="eager"
        />
        {post.featuredImage.credit && (
          <figcaption class="text-sm text-gray-500 mt-2 text-center">
            {post.featuredImage.credit}
          </figcaption>
        )}
      </figure>
    )}

    <!-- Content -->
    <div class="prose prose-lg max-w-none" set:html={content} />

    <!-- Tags -->
    {post.tags && post.tags.length > 0 && (
      <div class="mt-8 pt-8 border-t">
        <h3 class="font-semibold mb-3">Related Topics:</h3>
        <div class="flex flex-wrap gap-2">
          {post.tags.map(tag => (
            <span class="bg-gray-100 px-3 py-1 rounded-full text-sm">
              #{tag.title}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Dev Info -->
    {post.generationCost && (
      <div class="mt-8 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
        <p>Content Tier: {post.contentTier}</p>
        <p>Focus Keyword: {post.focusKeyword}</p>
        <p>Generation Cost: ${post.generationCost}</p>
      </div>
    )}
  </article>
</Layout>