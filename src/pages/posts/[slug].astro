---
import Layout from '../../layouts/Layout.astro';
import { sanityClient } from '../../lib/sanity';

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(`
    *[_type == "post"] {
      slug
    }
  `);

  return posts.map(post => ({
    params: { slug: post.slug.current }
  }));
}

const { slug } = Astro.params;

// Fetch the specific post
const post = await sanityClient.fetch(`
  *[_type == "post" && slug.current == $slug][0] {
    _id,
    title,
    slug,
    excerpt,
    body[] {
      ...,
      _type == 'image' => {
        ...,
        asset-> {
          url,
          metadata {
            dimensions
          }
        }
      }
    },
    publishedAt,
    featuredImage {
      asset-> {
        url
      },
      alt,
      credit
    },
    videoUrl,
    category-> {
      title,
      slug
    },
    tags[]-> {
      title,
      slug
    },
    metaTitle,
    metaDescription,
    focusKeyword,
    searchVolume,
    cpc,
    contentTier,
    generationCost
  }
`, { slug });

if (!post) {
  return Astro.redirect('/404');
}

// Enhanced portable text renderer with links and proper image handling
function renderPortableText(blocks) {
  if (!blocks) return '';
  
  return blocks.map(block => {
    if (block._type === 'block') {
      const style = block.style || 'normal';
      
      // Process children with mark definitions (for links)
      const children = block.children?.map(child => {
        if (child._type === 'span') {
          let text = child.text || '';
          
          // Handle marks (bold, italic, code, links)
          if (child.marks && child.marks.length > 0) {
            child.marks.forEach(mark => {
              if (mark === 'strong') {
                text = `<strong>${text}</strong>`;
              } else if (mark === 'em') {
                text = `<em>${text}</em>`;
              } else if (mark === 'code') {
                text = `<code class="bg-gray-100 px-1 py-0.5 rounded">${text}</code>`;
              } else {
                // Handle links via markDefs
                const markDef = block.markDefs?.find(def => def._key === mark);
                if (markDef && markDef._type === 'link') {
                  const isExternal = markDef.href?.startsWith('http');
                  const linkClass = isExternal 
                    ? 'text-blue-600 hover:text-blue-800 underline' 
                    : 'text-blue-600 hover:text-blue-800 underline';
                  const target = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
                  text = `<a href="${markDef.href}" class="${linkClass}"${target}>${text}</a>`;
                }
              }
            });
          }
          return text;
        }
        return '';
      }).join('');
      
      switch(style) {
        case 'h2': return `<h2 class="text-3xl font-bold mt-8 mb-4">${children}</h2>`;
        case 'h3': return `<h3 class="text-2xl font-bold mt-6 mb-3">${children}</h3>`;
        case 'h4': return `<h4 class="text-xl font-bold mt-4 mb-2">${children}</h4>`;
        case 'blockquote': return `<blockquote class="border-l-4 border-blue-500 pl-4 my-4 italic">${children}</blockquote>`;
        default: return `<p class="mb-4 leading-relaxed">${children}</p>`;
      }
    } else if (block._type === 'image') {
      const imageUrl = block.asset?.url || '';
      const alt = block.alt || '';
      const caption = block.caption || '';
      
      return `
        <figure class="my-8">
          <img src="${imageUrl}" alt="${alt}" class="w-full rounded-lg shadow-lg" loading="lazy" />
          ${caption ? `<figcaption class="text-sm text-gray-600 text-center mt-2">${caption}</figcaption>` : ''}
        </figure>
      `;
    }
    return '';
  }).join('');
}

// Extract MUX video ID from URL if it's a MUX video
function getMuxVideoId(url) {
  if (!url) return null;
  // MUX playback IDs are typically alphanumeric strings
  const match = url.match(/([a-zA-Z0-9]{20,})/);
  return match ? match[1] : null;
}

const pageTitle = post.metaTitle || post.title;
const pageDescription = post.metaDescription || post.excerpt;
---

<Layout title={pageTitle} description={pageDescription}>
  <article class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Breadcrumbs -->
    <nav class="text-sm mb-6">
      <a href="/" class="text-blue-600 hover:underline">Home</a>
      <span class="mx-2">/</span>
      <a href="/posts" class="text-blue-600 hover:underline">Posts</a>
      <span class="mx-2">/</span>
      <span class="text-gray-600">{post.title}</span>
    </nav>

    <!-- Article Header -->
    <header class="mb-8">
      {post.category && (
        <span class="text-blue-600 font-semibold uppercase text-sm">
          {post.category.title}
        </span>
      )}
      <h1 class="text-4xl md:text-5xl font-bold mt-2 mb-4">{post.title}</h1>
      
      <div class="flex items-center gap-4 text-gray-600">
        <time datetime={post.publishedAt}>
          {new Date(post.publishedAt).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          })}
        </time>
        {post.searchVolume && (
          <>
            <span>•</span>
            <span>{post.searchVolume} searches/month</span>
          </>
        )}
        {post.cpc && (
          <>
            <span>•</span>
            <span>${post.cpc} CPC</span>
          </>
        )}
      </div>
    </header>

    <!-- Featured Image or Video -->
    {post.videoUrl && getMuxVideoId(post.videoUrl) ? (
      <div class="mb-8">
        <mux-player
          playback-id={getMuxVideoId(post.videoUrl)}
          metadata-video-title={post.title}
          metadata-viewer-user-id="user-id-007"
          accent-color="#10b981"
          controls
          class="w-full rounded-lg shadow-lg"
        ></mux-player>
        <script src="https://cdn.jsdelivr.net/npm/@mux/mux-player"></script>
      </div>
    ) : post.featuredImage?.asset?.url && (
      <figure class="mb-8">
        <img 
          src={post.featuredImage.asset.url} 
          alt={post.featuredImage.alt || post.title}
          class="w-full rounded-lg shadow-lg"
        />
        {post.featuredImage.credit && (
          <figcaption class="text-sm text-gray-500 mt-2 text-center">
            {post.featuredImage.credit}
          </figcaption>
        )}
      </figure>
    )}

    <!-- Article Content -->
    <div class="prose prose-lg max-w-none" set:html={renderPortableText(post.body)} />

    <!-- Tags -->
    {post.tags && post.tags.length > 0 && (
      <div class="mt-8 pt-8 border-t">
        <h3 class="font-semibold mb-3">Related Topics:</h3>
        <div class="flex flex-wrap gap-2">
          {post.tags.map(tag => (
            <span class="bg-gray-100 px-3 py-1 rounded-full text-sm">
              #{tag.title}
            </span>
          ))}
        </div>
      </div>
    )}

    <!-- Article Metadata (for development) -->
    {post.generationCost && (
      <div class="mt-8 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
        <p>Content Tier: {post.contentTier}</p>
        <p>Focus Keyword: {post.focusKeyword}</p>
        <p>Generation Cost: ${post.generationCost}</p>
      </div>
    )}
  </article>
</Layout>